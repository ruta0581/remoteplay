<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>RemotePad クライアント</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
    .main { max-width: 600px; margin: 24px auto; background: #fff; border-radius: 10px; box-shadow: 0 0 10px #bbb; padding: 28px; }
    h2 { margin-top: 0; }
    .row { display: flex; gap: 14px; align-items: center; margin-bottom: 12px; }
    .label { min-width: 72px; text-align: right; }
    #pad-indicator { display:inline-block; border-radius:50%; width:22px; height:22px; margin-left:8px; background:#aaa; vertical-align:middle; transition:background 0.1s; }
    #pad-indicator.active { background:#2ecc40; }
    #vdo-iframe { width:100%; min-height:240px; border:1px solid #aaa; border-radius:10px; margin-top:18px;}
    #connectbtn { min-width:92px; font-size:1em; padding:6px 16px; border-radius:8px; border:none; font-weight:bold; cursor:pointer;}
    .err { color:#d33; margin-left:10px;}
    .status { font-size:0.98em; color:#008;}
    #gamepad-select, #wsl-addr, #username { font-size:1em; }
  </style>
</head>
<body>
  <div class="main">
    <h2>RemotePad クライアント</h2>
    <div class="row">
      <span class="label">名前</span>
      <input id="username" maxlength="10" style="flex:1;">
      <span id="nameerr" class="err"></span>
    </div>
    <div class="row">
      <span class="label">WSLアドレス</span>
      <input id="wsl-addr" style="flex:1;">
    </div>
    <div class="row">
      <span class="label">ゲームパッド</span>
      <select id="gamepad-select" style="flex:1;"></select>
      <span id="pad-indicator"></span>
    </div>
    <div class="row">
      <button id="connectbtn" style="background:#2196f3;color:#fff;">接続</button>
      <span id="status" class="status"></span>
    </div>
    <iframe id="vdo-iframe" allow="autoplay; fullscreen"></iframe>
  </div>
<script>
let ws = null, pc = null, dataChannel = null;
let connected = false, connecting = false;
let lastPadActive = false;

function setFormLock(lock) {
  document.getElementById('username').disabled = lock;
  document.getElementById('wsl-addr').disabled = lock;
  document.getElementById('gamepad-select').disabled = lock;
}

function setStatus(msg) {
  document.getElementById('status').textContent = msg || "";
}

function updatePadIndicator(active) {
  const el = document.getElementById('pad-indicator');
  el.className = active ? "active" : "";
}

function refreshPadList() {
  const select = document.getElementById('gamepad-select');
  const pads = navigator.getGamepads();
  select.innerHTML = "";
  let found = false;
  for (let i = 0; i < pads.length; ++i) {
    const p = pads[i];
    if (p && p.connected) {
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `#${i}: ${p.id}`;
      select.appendChild(opt);
      found = true;
    }
  }
  if (!found) {
    const opt = document.createElement('option');
    opt.value = "";
    opt.textContent = "ゲームパッド未接続";
    select.appendChild(opt);
  }
}
window.addEventListener('gamepadconnected', refreshPadList);
window.addEventListener('gamepaddisconnected', refreshPadList);
refreshPadList();

function disconnectCleanup() {
  if (dataChannel && dataChannel.readyState === "open") try { dataChannel.close(); } catch {}
  if (pc) try { pc.close(); } catch {}
  if (ws && ws.readyState <= 1) try { ws.close(); } catch {}
  dataChannel = null;
  pc = null;
  ws = null;
  connected = false;
  connecting = false;
  setFormLock(false);
  document.getElementById('connectbtn').textContent = '接続';
  setStatus('切断しました');
  updatePadIndicator(false);
  refreshPadList();
  document.getElementById("vdo-iframe").src = "";
}

document.getElementById('connectbtn').onclick = () => {
  if (connected || connecting) {
    disconnectCleanup();
    return;
  }
  // 入力バリデーション
  const username = document.getElementById('username').value.trim();
  if (!username || username.length > 10) {
    document.getElementById('nameerr').textContent = '10文字以内で入力';
    return;
  }
  document.getElementById('nameerr').textContent = '';
  setFormLock(true);
  document.getElementById('connectbtn').textContent = '切断';
  setStatus('接続中...');
  connecting = true;

  ws = new WebSocket(document.getElementById('wsl-addr').value.trim());
  ws.onclose = ws.onerror = () => { disconnectCleanup(); };
  ws.onmessage = function(e) {
    const msg = JSON.parse(e.data);
    if (msg.type === "offer") {
      pc = new RTCPeerConnection();
      pc.onicecandidate = e => {
        if (e.candidate) ws.send(JSON.stringify({ type: "candidate", candidate: e.candidate }));
      };
      pc.ondatachannel = ev => {
        dataChannel = ev.channel;
        dataChannel.onopen = () => {
          connected = true;
          connecting = false;
          setStatus('接続完了');
          setFormLock(true);
          document.getElementById('connectbtn').textContent = '切断';
          // hello送信
          dataChannel.send(JSON.stringify({
            type: "hello",
            name: username,
            id: Math.random().toString(36).slice(2,12)
          }));
        };
        dataChannel.onclose = dataChannel.onerror = () => disconnectCleanup();
        dataChannel.onmessage = ev => {
          try {
            const msg = JSON.parse(typeof ev.data === "string" ? ev.data : "");
            if (msg.type === "ninja_id" && msg.id) {
              document.getElementById("vdo-iframe").src = "https://vdo.ninja/?view=" + encodeURIComponent(msg.id) + "&nojitter";
              return;
            }
            // サーバーからのdisconnectコマンドで安全に自動切断
            if (msg.type === "disconnect") {
              disconnectCleanup();
              return;
            }
          } catch {}
        };
      };
      pc.setRemoteDescription(msg.offer).then(() => {
        return pc.createAnswer();
      }).then(answer => {
        return pc.setLocalDescription(answer);
      }).then(() => {
        ws.send(JSON.stringify({ type: "answer", answer: pc.localDescription }));
      });
    } else if (msg.type === "candidate") {
      pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
    }
  };
};

function sendPadState() {
  if (!connected || !dataChannel || dataChannel.readyState !== "open") {
    updatePadIndicator(false);
    return;
  }
  const pads = navigator.getGamepads();
  const select = document.getElementById('gamepad-select');
  const idx = Number(select.value);
  const pad = pads && pads[idx];
  if (!pad) {
    updatePadIndicator(false);
    return;
  }
  // Pad state (A/B/X/Y/L/R/Start/Dpad/Lx/Ly/Rx/Ry/LT/RT)
  let btnBits = 0;
  function b(i, n) { if (pad.buttons[i]?.pressed) btnBits |= (1 << n); }
  b(0,0);b(1,1);b(2,2);b(3,3);b(4,4);b(5,5);b(8,8);b(9,9); //A,B,X,Y,L,R,Back,Start
  // Dpad
  b(12,12);b(13,13);b(14,14);b(15,15);
  const lx = Math.round(((pad.axes[0] || 0) + 1) * 127.5);
  const ly = Math.round((-(pad.axes[1] || 0) + 1) * 127.5);
  const rx = Math.round(((pad.axes[2] || 0) + 1) * 127.5);
  const ry = Math.round((-(pad.axes[3] || 0) + 1) * 127.5);
  const lt = Math.round((pad.buttons[6]?.value || 0) * 255);
  const rt = Math.round((pad.buttons[7]?.value || 0) * 255);
  const buf = new Uint8Array([btnBits & 0xFF, btnBits >> 8, lx, ly, rx, ry, lt, rt]);
  try {
    dataChannel.send(buf);
    // どれかボタン/スティックが押されていればindicator点灯
    let active = !!btnBits || Math.abs(lx-128)>20 || Math.abs(ly-128)>20 || Math.abs(rx-128)>20 || Math.abs(ry-128)>20 || lt>10 || rt>10;
    updatePadIndicator(active);
  } catch(e){
    updatePadIndicator(false);
  }
}
setInterval(sendPadState, 50);
</script>
</body>
</html>
